import streamlit as st
import pandas as pd
import sqlite3

# Sayfa AyarlarÄ±
st.set_page_config(page_title="3D AtÃ¶lye ERP", layout="wide")

def excel_islee(uploaded_file):
    try:
        # 1. FÄ°LAMENT SAYFASINI OKU
        # Filament sayfan dÃ¼zgÃ¼n, direkt okuyoruz
        df_fil = pd.read_excel(uploaded_file, sheet_name=0)
        
        # 2. HIRDAVAT SAYFASINI OKU (Ã–NEMLÄ° DÃœZELTME BURADA)
        # header=1 diyoruz ki en Ã¼stteki "STANDART MALZEMELER" yazÄ±sÄ±nÄ± atlasÄ±n.
        df_hir = pd.read_excel(uploaded_file, sheet_name=1, header=1, usecols="A:H")
        
        # SÃ¼tun isimlerini biz verelim ki Excel'deki "ÃœRÃœN\nADI" gibi alt satÄ±ra geÃ§en yazÄ±lar hata vermesin
        df_hir.columns = ['DIN_KOD', 'URUN_ADI', 'ACIKLAMA', 'STOK_ADET', 'ALINAN_ADET', 'ALIS_FIYATI', 'TEDARIKCI', 'TARIH']
        
        # Temizlik: FiyatÄ± boÅŸ olan veya sayÄ± olmayan satÄ±rlarÄ± at
        df_hir = df_hir.dropna(subset=['ALIS_FIYATI'])
        df_hir = df_hir[pd.to_numeric(df_hir['ALIS_FIYATI'], errors='coerce').notnull()]
        
        # Maliyet HesabÄ± (Toplam Fiyat / Toplam Adet)
        df_hir['Birim_Maliyet'] = df_hir['ALIS_FIYATI'] / df_hir['ALINAN_ADET']
        
        return df_fil, df_hir
    except Exception as e:
        st.error(f"Hata DetayÄ±: {e}")
        return None, None

st.title("ğŸ› ï¸ Bulut AtÃ¶lye ERP")
st.markdown("---")

dosya = st.file_uploader("SARF MALZEME.xlsx DosyanÄ± YÃ¼kle", type=['xlsx'])

if dosya:
    fil_df, hir_df = excel_islee(dosya)
    
    if fil_df is not None and hir_df is not None:
        st.success("âœ… Excel BaÅŸarÄ±yla Okundu!")
        
        tab1, tab2, tab3 = st.tabs(["ğŸ§µ Filament Stok", "ğŸ”© HÄ±rdavat & Maliyet", "ğŸ’° ÃœrÃ¼n Maliyet Hesapla"])
        
        with tab1:
            st.dataframe(fil_df, use_container_width=True)
            # KÄ±sa Ã¶zet
            st.info(f"Toplam {len(fil_df)} makara filament kaydÄ± var.")

        with tab2:
            # Sadece Ã¶nemli sÃ¼tunlarÄ± gÃ¶sterelim
            gosterilecek_tablo = hir_df[['URUN_ADI', 'ACIKLAMA', 'STOK_ADET', 'Birim_Maliyet']].copy()
            st.dataframe(gosterilecek_tablo, use_container_width=True)
            st.caption("â„¹ï¸ Birim maliyetler, paket fiyatÄ±nÄ±n adede bÃ¶lÃ¼nmesiyle hesaplanmÄ±ÅŸtÄ±r.")

        with tab3:
            st.header("Maliyet HesaplayÄ±cÄ±")
            
            col1, col2 = st.columns(2)
            with col1:
                # KullanÄ±cÄ±ya listeden Ã¼rÃ¼n seÃ§tiriyoruz
                liste = hir_df['URUN_ADI'].astype(str) + " - " + hir_df['ACIKLAMA'].astype(str)
                secim = st.selectbox("Malzeme SeÃ§", liste)
                adet = st.number_input("KaÃ§ Adet LazÄ±m?", min_value=1, value=1)
                
            with col2:
                # SeÃ§ilen Ã¼rÃ¼nÃ¼n fiyatÄ±nÄ± bulup hesaplÄ±yoruz
                secilen_veri = hir_df.iloc[liste[liste == secim].index[0]]
                birim_fiyat = secilen_veri['Birim_Maliyet']
                
                hirdavat_tutari = birim_fiyat * adet
                st.metric("ParÃ§a Maliyeti", f"{hirdavat_tutari:.2f} TL")
            
            st.divider()
            
            # Filament HesabÄ±
            f_gram = st.number_input("Harcanacak Filament (Gram)", value=50)
            f_birim_fiyat = st.number_input("Filament Gram Maliyeti (Ortalama 0.6 TL)", value=0.60)
            fil_tutari = f_gram * f_birim_fiyat
            
            st.warning(f"TOPLAM MALÄ°YET: {hirdavat_tutari + fil_tutari:.2f} TL")

    else:
        st.warning("Dosya okunurken bir sorun oldu. LÃ¼tfen sÃ¼tun baÅŸlÄ±klarÄ±nÄ± kontrol et.")