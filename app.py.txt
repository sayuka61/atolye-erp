import streamlit as st
import pandas as pd
import sqlite3

# Sayfa AyarlarÄ±
st.set_page_config(page_title="3D AtÃ¶lye ERP", layout="wide")

# VeritabanÄ± BaÄŸlantÄ±sÄ± (Bellekte Ã§alÄ±ÅŸÄ±r, sayfa yenilenince sÄ±fÄ±rlanÄ±r - Cloud iÃ§in en basiti budur)
# Ä°leride kalÄ±cÄ± veritabanÄ± istersen Google Sheets baÄŸlarÄ±z.
conn = sqlite3.connect(':memory:', check_same_thread=False)

def excel_islee(uploaded_file):
    try:
        # Filamentleri Oku
        df_fil = pd.read_excel(uploaded_file, sheet_name=0)
        
        # HÄ±rdavatlarÄ± Oku (Sadece soldaki tabloyu alÄ±yoruz)
        df_hir = pd.read_excel(uploaded_file, sheet_name=1, usecols="A:H")
        
        # Temizlik
        df_hir = df_hir.dropna(subset=['ALIÅ FÄ°YATI']) # BoÅŸ satÄ±rlarÄ± at
        df_hir = df_hir[df_hir['ALIÅ FÄ°YATI'].apply(lambda x: str(x).isnumeric() or isinstance(x, (int, float)))]
        
        # Maliyet HesabÄ±
        df_hir['Birim Maliyet'] = df_hir['ALIÅ FÄ°YATI'] / df_hir['ALINAN ADET']
        
        return df_fil, df_hir
    except Exception as e:
        return None, None

st.title("ğŸ› ï¸ Bulut AtÃ¶lye ERP")
st.write("Excel dosyanÄ± yÃ¼kle, stoklarÄ±nÄ± ve maliyetlerini anÄ±nda gÃ¶r.")

dosya = st.file_uploader("SARF MALZEME.xlsx DosyanÄ± Buraya BÄ±rak", type=['xlsx'])

if dosya:
    fil_df, hir_df = excel_islee(dosya)
    
    if fil_df is not None:
        st.success("Dosya baÅŸarÄ±yla okundu!")
        
        tab1, tab2, tab3 = st.tabs(["ğŸ§µ Filamentler", "ğŸ”© HÄ±rdavat & Maliyet", "ğŸ“‹ BOM (ReÃ§ete) Hesapla"])
        
        with tab1:
            st.dataframe(fil_df, use_container_width=True)
            
            # Ã–zet Bilgi
            aktifler = fil_df[fil_df['DURUM'] == 'AKTÄ°F'].shape[0]
            st.info(f"Åu an makinede takÄ±lÄ± {aktifler} makara filament var.")

        with tab2:
            st.dataframe(hir_df[['ÃœRÃœN ADI', 'ÃœRÃœN \nAÃ‡KLAMA', 'STOK\nADET', 'Birim Maliyet']], use_container_width=True)
            st.caption("Not: Birim maliyetler paket fiyatÄ±ndan otomatik hesaplandÄ±.")

        with tab3:
            st.header("Maliyet HesaplayÄ±cÄ±")
            st.write("Bir Ã¼rÃ¼n iÃ§in ne harcayacaÄŸÄ±nÄ± seÃ§, maliyeti gÃ¶r.")
            
            col1, col2 = st.columns(2)
            with col1:
                secilen_somun = st.selectbox("HÄ±rdavat SeÃ§", hir_df['ÃœRÃœN ADI'] + " " + hir_df['ÃœRÃœN \nAÃ‡KLAMA'])
                adet = st.number_input("KaÃ§ tane lazÄ±m?", min_value=1, value=4)
            
            with col2:
                # SeÃ§ilen Ã¼rÃ¼nÃ¼n fiyatÄ±nÄ± bul
                secilen_veri = hir_df[hir_df['ÃœRÃœN ADI'] + " " + hir_df['ÃœRÃœN \nAÃ‡KLAMA'] == secilen_somun].iloc[0]
                birim_fiyat = secilen_veri['Birim Maliyet']
                toplam_hirdavat = birim_fiyat * adet
                
                st.metric("HÄ±rdavat Maliyeti", f"{toplam_hirdavat:.2f} TL")
            
            st.divider()
            filament_gr = st.number_input("Tahmini Filament HarcamasÄ± (Gram)", value=100)
            # Ortalama filament maliyeti (Basit hesap: 600 TL / 1000gr = 0.6 TL/gr)
            filament_maliyet = filament_gr * 0.6 
            st.metric("Filament Maliyeti (Tahmini)", f"{filament_maliyet:.2f} TL")
            
            st.success(f"TOPLAM ÃœRETÄ°M MALÄ°YETÄ°: {toplam_hirdavat + filament_maliyet:.2f} TL")

    else:
        st.error("Excel formatÄ±nda bir hata var, lÃ¼tfen sÃ¼tunlarÄ± kontrol et.")